<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯†é’¥ç®¡ç† - Hajimi King</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link rel="stylesheet" href="/static/css/vendor/element-plus.css">
    <script src="/static/js/vue.global.prod.js"></script>
    <script src="/static/js/element-plus.js"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
        }
        #app {
            min-height: 100vh;
        }
        .header {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 16px 0;
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #409eff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav {
            display: flex;
            gap: 20px;
        }
        .nav a {
            text-decoration: none;
            color: #606266;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav a:hover {
            color: #409eff;
        }
        .main-container {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .filter-bar {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }
        .table-container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 2rem;">
                    <div class="logo">
                        <span style="font-size: 28px;">ğŸ‘‘</span>
                        <span>Hajimi King</span>
                    </div>
                    <div class="nav">
                        <a href="/">ğŸ“Š ä»ªè¡¨ç›˜</a>
                        <a href="/keys" class="active">ğŸ”‘ å¯†é’¥ç®¡ç†</a>
                        <a href="/stats">ğŸ“ˆ ç»Ÿè®¡åˆ†æ</a>
                        <a href="/config">âš™ï¸ ç³»ç»Ÿé…ç½®</a>
                    </div>
                </div>
                <div>
                    <el-button type="danger" size="small" @click="logout">é€€å‡ºç™»å½•</el-button>
                </div>
            </div>
        </div>

        <div class="main-container">
            <!-- ç­›é€‰æ  -->
            <div class="filter-bar">
                <el-row :gutter="20">
                    <el-col :span="6">
                        <el-select v-model="filters.provider" placeholder="é€‰æ‹©ä¾›åº”å•†" clearable @change="loadKeys">
                            <el-option label="Gemini" value="gemini"></el-option>
                            <el-option label="OpenAI" value="openai"></el-option>
                            <el-option label="OpenRouter" value="openrouter"></el-option>
                            <el-option label="Cerebras" value="cerebras"></el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="6">
                        <el-select v-model="filters.status" placeholder="é€‰æ‹©çŠ¶æ€" clearable @change="loadKeys">
                            <el-option label="æœ‰æ•ˆ" value="valid"></el-option>
                            <el-option label="é™æµ" value="rate_limited"></el-option>
                            <el-option label="æ— æ•ˆ" value="invalid"></el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="12">
                        <el-input
                            v-model="filters.search"
                            placeholder="æœç´¢ä»“åº“åæˆ–å¯†é’¥"
                            clearable
                            @keyup.enter="loadKeys"
                        >
                            <template #append>
                                <el-button @click="loadKeys" icon="Search">æœç´¢</el-button>
                            </template>
                        </el-input>
                    </el-col>
                </el-row>
            </div>

            <!-- å¯†é’¥è¡¨æ ¼ -->
            <div class="table-container">
                <el-table
                    :data="keys"
                    stripe
                    v-loading="loading"
                    @selection-change="handleSelectionChange"
                >
                    <el-table-column type="selection" width="55"></el-table-column>
                    <el-table-column prop="id" label="ID" width="80"></el-table-column>
                    <el-table-column prop="provider" label="ä¾›åº”å•†" width="120">
                        <template #default="scope">
                            <el-tag>{{ scope.row.provider }}</el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="key_preview" label="å¯†é’¥é¢„è§ˆ" width="180">
                        <template #default="scope">
                            <el-button
                                link
                                type="primary"
                                @click="showKeyDetail(scope.row.id)"
                            >
                                {{ scope.row.key_preview }}
                            </el-button>
                        </template>
                    </el-table-column>
                    <el-table-column prop="source_repo" label="æ¥æºä»“åº“" min-width="200"></el-table-column>
                    <el-table-column prop="status" label="çŠ¶æ€" width="100">
                        <template #default="scope">
                            <el-tag v-if="scope.row.status === 'valid'" type="success">æœ‰æ•ˆ</el-tag>
                            <el-tag v-else-if="scope.row.status === 'rate_limited'" type="warning">é™æµ</el-tag>
                            <el-tag v-else type="info">æ— æ•ˆ</el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column label="åŒæ­¥çŠ¶æ€" width="120">
                        <template #default="scope">
                            <el-icon v-if="scope.row.synced_to_balancer || scope.row.synced_to_gpt_load" color="#67c23a"><SuccessFilled /></el-icon>
                            <el-icon v-else color="#909399"><CircleCloseFilled /></el-icon>
                        </template>
                    </el-table-column>
                    <el-table-column prop="discovered_at" label="å‘ç°æ—¶é—´" width="180">
                        <template #default="scope">
                            {{ formatTime(scope.row.discovered_at) }}
                        </template>
                    </el-table-column>
                    <el-table-column label="æ“ä½œ" width="180" fixed="right">
                        <template #default="scope">
                            <el-button link type="primary" size="small" @click="showKeyDetail(scope.row.id)">è¯¦æƒ…</el-button>
                            <el-button link type="danger" size="small" @click="deleteKey(scope.row.id)">åˆ é™¤</el-button>
                        </template>
                    </el-table-column>
                </el-table>

                <!-- åˆ†é¡µ -->
                <el-pagination
                    v-model:current-page="pagination.page"
                    v-model:page-size="pagination.page_size"
                    :total="pagination.total"
                    :page-sizes="[20, 50, 100]"
                    layout="total, sizes, prev, pager, next, jumper"
                    @current-change="loadKeys"
                    @size-change="loadKeys"
                    style="margin-top: 20px; justify-content: flex-end;"
                />

                <!-- æ‰¹é‡æ“ä½œ -->
                <div v-if="selectedKeys.length > 0" style="margin-top: 20px;">
                    <el-button type="danger" @click="batchDelete">æ‰¹é‡åˆ é™¤ ({{ selectedKeys.length }})</el-button>
                </div>
            </div>
        </div>

        <!-- å¯†é’¥è¯¦æƒ…å¼¹çª— -->
        <el-dialog v-model="detailDialogVisible" title="å¯†é’¥è¯¦æƒ…" width="800px">
            <el-descriptions v-if="currentKey" :column="2" border>
                <el-descriptions-item label="ID">{{ currentKey.id }}</el-descriptions-item>
                <el-descriptions-item label="ä¾›åº”å•†">{{ currentKey.provider }}</el-descriptions-item>
                <el-descriptions-item label="çŠ¶æ€">
                    <el-tag v-if="currentKey.status === 'valid'" type="success">æœ‰æ•ˆ</el-tag>
                    <el-tag v-else-if="currentKey.status === 'rate_limited'" type="warning">é™æµ</el-tag>
                    <el-tag v-else type="info">æ— æ•ˆ</el-tag>
                </el-descriptions-item>
                <el-descriptions-item label="GPT Load åˆ†ç»„">{{ currentKey.gpt_load_group_name || 'æœªé…ç½®' }}</el-descriptions-item>
                <el-descriptions-item label="å®Œæ•´å¯†é’¥" :span="2">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <el-input v-model="currentKey.key" readonly></el-input>
                        <el-button @click="copyKey(currentKey.key)">å¤åˆ¶</el-button>
                    </div>
                </el-descriptions-item>
                <el-descriptions-item label="æ¥æºä»“åº“" :span="2">
                    <a :href="`https://github.com/${currentKey.source_repo}`" target="_blank">{{ currentKey.source_repo }}</a>
                </el-descriptions-item>
                <el-descriptions-item label="æ–‡ä»¶è·¯å¾„" :span="2">{{ currentKey.source_file_path }}</el-descriptions-item>
                <el-descriptions-item label="æ–‡ä»¶ URL" :span="2">
                    <a :href="currentKey.source_file_url" target="_blank">æŸ¥çœ‹æ–‡ä»¶</a>
                </el-descriptions-item>
                <el-descriptions-item label="å‘ç°æ—¶é—´">{{ formatTime(currentKey.discovered_at) }}</el-descriptions-item>
                <el-descriptions-item label="æœ€åéªŒè¯">{{ formatTime(currentKey.last_validated_at) }}</el-descriptions-item>
                <el-descriptions-item label="åŒæ­¥çŠ¶æ€">
                    Balancer: {{ currentKey.synced_to_balancer ? 'å·²åŒæ­¥' : 'æœªåŒæ­¥' }}<br>
                    GPT Load: {{ currentKey.synced_to_gpt_load ? 'å·²åŒæ­¥' : 'æœªåŒæ­¥' }}
                </el-descriptions-item>
            </el-descriptions>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            data() {
                return {
                    keys: [],
                    selectedKeys: [],
                    loading: false,
                    filters: {
                        provider: '',
                        status: '',
                        search: ''
                    },
                    pagination: {
                        page: 1,
                        page_size: 20,
                        total: 0
                    },
                    detailDialogVisible: false,
                    currentKey: null
                };
            },
            mounted() {
                this.loadKeys();
            },
            methods: {
                async loadKeys() {
                    this.loading = true;
                    try {
                        const params = new URLSearchParams({
                            page: this.pagination.page,
                            page_size: this.pagination.page_size
                        });

                        if (this.filters.provider) params.append('provider', this.filters.provider);
                        if (this.filters.status) params.append('status', this.filters.status);
                        if (this.filters.search) params.append('search', this.filters.search);

                        const response = await fetch(`/api/keys/?${params}`);
                        const data = await response.json();

                        this.keys = data.items;
                        this.pagination.total = data.total;
                    } catch (error) {
                        ElMessage.error('åŠ è½½å¯†é’¥åˆ—è¡¨å¤±è´¥');
                    } finally {
                        this.loading = false;
                    }
                },
                async showKeyDetail(keyId) {
                    try {
                        const response = await fetch(`/api/keys/${keyId}`);
                        this.currentKey = await response.json();
                        this.detailDialogVisible = true;
                    } catch (error) {
                        ElMessage.error('åŠ è½½å¯†é’¥è¯¦æƒ…å¤±è´¥');
                    }
                },
                async deleteKey(keyId) {
                    try {
                        await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯†é’¥å—ï¼Ÿ', 'æç¤º', {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        });

                        const response = await fetch(`/api/keys/${keyId}`, { method: 'DELETE' });
                        if (response.ok) {
                            ElMessage.success('åˆ é™¤æˆåŠŸ');
                            this.loadKeys();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('åˆ é™¤å¤±è´¥');
                        }
                    }
                },
                async batchDelete() {
                    try {
                        await ElMessageBox.confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${this.selectedKeys.length} ä¸ªå¯†é’¥å—ï¼Ÿ`, 'æç¤º', {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        });

                        const keyIds = this.selectedKeys.map(k => k.id);
                        const response = await fetch('/api/keys/batch-delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(keyIds)
                        });

                        if (response.ok) {
                            ElMessage.success('æ‰¹é‡åˆ é™¤æˆåŠŸ');
                            this.loadKeys();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('æ‰¹é‡åˆ é™¤å¤±è´¥');
                        }
                    }
                },
                handleSelectionChange(selection) {
                    this.selectedKeys = selection;
                },
                copyKey(key) {
                    navigator.clipboard.writeText(key).then(() => {
                        ElMessage.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    });
                },
                formatTime(timestamp) {
                    if (!timestamp) return '-';
                    const date = new Date(timestamp);
                    return date.toLocaleString('zh-CN');
                },
                logout() {
                    localStorage.removeItem('access_token');
                    window.location.href = '/login';
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
